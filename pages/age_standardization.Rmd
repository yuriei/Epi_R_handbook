---
title:  |  
  ![](../images/R Handbook Logo.png)
author: ""
date: "Produced `r format(Sys.time(), '%A %d %B %Y')`"
output:
  html_document:
    code_folding: show
    highlight: zenburn
    number_sections: no
    theme: sandstone
    toc: yes
    toc_collapse: no
    toc_depth: 3
    toc_float: yes
params:
    run_page_ind: TRUE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "_outputs_knitted") })
---

```{r, child= '_page_setup.Rmd', eval = params$run_page_ind, include = F}
```


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# Standardization {#agestandardize .tabset .tabset-fade}  

This page will show you two ways to standardize an outcome, such as hospitalizations or mortality, by characteristics such as age and sex. 

* Using **PHEindicatormethods** package
* Using **dsr** package 
`{#title_tag .tabset .tabset-fade}`

<!-- ======================================================= -->
## Overview {.tabset .tabset-fade .tabset-pills}

There are two main ways to standardize: direct and indirect standardization.
Let's say we would like to standardize COVID-19 mortality in London by age and sex.

* For direct standardization, you will have to know the number of the at-risk population and number of deaths for each age and sex stratum. One stratum in our example could be females between ages 15-44. 
* For indirect standardization, you only need to know the total number of deaths and the age- and sex structure in our study population, London. This option is therefore feasible if age- and sex-specific mortality rates or population numbers are not available. Indirect standardization is furthermore preferable in case of small numbers per stratum, as estimates in direct standardization would be influenced by substantial sampling variation. 

<!-- ======================================================= -->
## Preparation {.tabset .tabset-fade .tabset-pills}
<h2> Preparation </h2>

To show how indirect standardization is done, we will use the `country_demographics` dataset which includes population numbers by age (in 5 year categories) and sex (female, male). We will add our own fictitious mortality data to this dataset. To make the dataset ready for use, we will perform the following steps:

* We need one row per stratum of age and sex
* We need to add mortality numbers per stratum

Alternatively, instead of just adding mortality numbers per stratum you may have a dataset with one row for each death and information on age and sex for each (or a significant proportion) of these deaths. In this case, you can aggregate this dataset by age and sex to create a dataset with numbers per stratum, and then add this to the dataset with population numbers per stratum. We will also show you how to do this.

**Load packages**  

First, load the packages required for this analysis:  

```{r}
pacman::p_load(rio,       # to import data
               here,      # to locate files
               tidyverse, # to clean, handle, and plot the data (includes ggplot2 package)
               frailtypack, # needed for dsr, for frailty models
               dsr)  # a package for directly standardized rates
```
NB: you may get an error that the **dsr** package is not available if you try to install it (if you are using a newer version of R), as it has recently been removed from the CRAN repository. However, older versions have been archived, so you can download and use those.

For non-Mac users:
```{r}
require(devtools)
install_version("dsr", version="0.2.2", repos="http:/cran.us.r.project.org")
```

For Mac users:
```{r}
require(devtools)
install_version("dsr", version="0.2.2", repos="https://mac.R-project.org")
```

**Then, load the data**  
```{r}
country_demo_data <- rio::import(here::here("data", "country_demographics.csv"))
View(country_demo_data) # view the data
names(country_demo_data) # look at variable names
```

**Now, prepare data for analysis**
We need a dataset with one record per stratum. The current dataset has males and females listed on the same row.

```{r}
# Make a data frame for males only and change the column name m
males_country <- country_demo_data %>% dplyr::select(age_cat5, m) # make dataframe for males only
males_country <- males_country %>% rename(tot = m) # rename column

# Do the same for females
females_country <- country_demo_data %>% dplyr::select(age_cat5, f) 
females_country <- females_country %>% rename(tot = f)

# Now join the rows
all_country <- rbind(males_country, females_country)
```

**Now, add mortality numbers**
```{r}
# Make a vector 
mortality_n <- c(34, 37, 51, 145, 234, 254, 200, 189, 334, 342, 565, 432, 543, 432, 245, 543, 234, 154,
                 54, 24, 32, 154, 276, 254, 123, 164, 254, 354, 453, 654, 435, 354, 165, 432, 287, 195)

# Add to the dataset
all_country$deaths <- mortality_n
```
FYI, we just add fictional data here


<!-- ======================================================= -->
### sub-tab 1 {.tabset .tabset-fade .tabset-pills}

Can be used to separate major steps of data preparation. Re-name as needed


<!-- ======================================================= -->
### sub-tab 2 {.tabset .tabset-fade .tabset-pills}

Can be used to separate major steps of data preparation. Re-name as needed.


<!-- ======================================================= -->
## **PHEindicatormethods** package {.tabset .tabset-fade .tabset-pills}


<!-- ======================================================= -->
## **DSR** package {.tabset .tabset-fade .tabset-pills}



<!-- ======================================================= -->
## Resources {.tabset .tabset-fade .tabset-pills}

This tab should stay with the name "Resources".
Links to other online tutorials or resources.




```{r, child= '_page_closeout.Rmd', eval = params$run_page_ind == F, include = F}
```


